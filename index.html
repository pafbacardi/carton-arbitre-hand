<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitre Handball</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§æ</text></svg>">
    <link rel="manifest" href="/carton-arbitre-hand/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: white;
            user-select: none;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .container {
            max-width: 100vw;
            height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            grid-template-columns: 1fr;
            gap: 10px;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Landscape Mode Specific Styles */
        @media (orientation: landscape) {
            .container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto 1fr;
                gap: 15px;
            }

            .main-timer-section {
                grid-column: 1 / 3; /* Spans across both columns */
                grid-row: 1;
            }

            .team-section-left {
                grid-column: 1;
                grid-row: 2;
            }

            .team-section-right {
                grid-column: 2;
                grid-row: 2;
            }

            .bottom-nav {
                grid-column: 1 / 3; /* Spans across both columns */
                grid-row: 3;
                margin-top: 10px;
            }
        }
        
        @media (min-width: 768px) { /* Tablets and Desktops */
            .container {
                max-width: 90%;
                margin: 0 auto;
                padding: 20px;
                height: auto;
            }

            .main-timer-section {
                padding: 20px;
            }

            .team-card {
                padding: 15px;
            }

            .bottom-nav button {
                padding: 15px 25px;
                font-size: 1.1em;
            }
            .modal-content {
                width: 70%;
                max-width: 700px;
            }
            .journal-entry {
                font-size: 1em;
            }
        }


        /* Timer Section */
        .main-timer-section {
            background-color: #333;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative; /* For the "TEMPS MORT" banner */
        }

        .period-info {
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 5px;
        }

        .timer {
            font-family: 'monospace';
            font-size: 4em;
            font-weight: bold;
            color: #FFD700; /* Gold */
            margin: 5px 0;
            display: flex;
            align-items: center;
        }

        .timer-separator {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .timer-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .timer-buttons button {
            padding: 8px 15px;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .timer-buttons button:hover {
            background-color: #777;
        }

        .timer-buttons button:active {
            background-color: #333;
        }

        /* Banner for Timeouts/Pauses */
        .banner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            width: 80%;
            display: none; /* Hidden by default */
            z-index: 10;
        }
        .banner.active {
            display: block;
        }
        
        .banner-timeout {
            background-color: rgba(255, 0, 0, 0.8);
        }
        .banner-pause {
            background-color: rgba(0, 0, 255, 0.8);
        }

        /* Team Sections */
        .team-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        .team-card {
            background-color: #222;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            flex: 1;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .team-name {
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            color: #FFD700;
        }

        .score-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .score-button {
            background-color: #FFD700;
            color: #1a1a1a;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .score-button:hover {
            background-color: #e0b800;
        }
        .score-button:active {
            background-color: #b38e00;
        }

        .score {
            font-size: 2em;
            font-weight: bold;
            margin: 0 10px;
            min-width: 40px; /* Ensure consistent width */
            text-align: center;
        }

        /* Sanctions & Timeouts */
        .sanctions-timeouts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }

        .sanction-button, .timeout-button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            color: #1a1a1a; /* Default text color for buttons */
        }

        .yellow-card { background-color: yellow; }
        .red-card { background-color: red; color: white; }
        .blue-card { background-color: blue; color: white; }
        .timeout-button { background-color: lightblue; }
        .two-min-exclusion { background-color: orange; }

        .yellow-card:hover { background-color: #e0e000; }
        .red-card:hover { background-color: #e00000; }
        .blue-card:hover { background-color: #0000e0; }
        .timeout-button:hover { background-color: #87ceeb; }
        .two-min-exclusion:hover { background-color: #e09200; }

        .yellow-card:active { background-color: #c0c000; }
        .red-card:active { background-color: #b30000; }
        .blue-card:active { background-color: #0000b3; }
        .timeout-button:active { background-color: #6495ed; }
        .two-min-exclusion:active { background-color: #b37300; }

        .timeouts-taken {
            margin-top: 5px;
            font-size: 0.8em;
            color: #bbb;
        }

        .sanction-list {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid #444;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }

        .sanction-item {
            background-color: #444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sanction-item.yellow { background-color: #ccaa00; }
        .sanction-item.red { background-color: #cc0000; }
        .sanction-item.blue { background-color: #0000cc; }

        .two-min-timer {
            background-color: #663300; /* Darker orange */
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 60px; /* Ensure timer width */
            justify-content: space-between;
        }

        .two-min-timer.active {
            background-color: #ff8c00; /* Bright orange for active */
        }
        .two-min-timer.inactive {
            background-color: #333; /* Grey for inactive */
            color: #aaa;
        }
        .two-min-timer.finished {
            background-color: green; /* Green for finished */
            color: white;
        }
        .two-min-timer.finished .timer-value {
            text-decoration: line-through; /* Strikethrough for finished timers */
        }

        .two-min-timer .player-num {
            font-weight: bold;
        }
        .two-min-timer .timer-value {
            font-family: 'monospace';
        }

        /* Bottom Navigation */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: #333;
            border-radius: 8px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            width: 100%; /* Ensure it spans full width */
            box-sizing: border-box; /* Include padding in width */
            gap: 5px;
        }

        .bottom-nav button {
            flex: 1;
            padding: 10px 15px;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }
        .bottom-nav button:hover {
            background-color: #777;
        }
        .bottom-nav button:active {
            background-color: #333;
        }
        .bottom-nav button .icon {
            font-size: 1.2em; /* Adjust icon size */
        }

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: #2a2a2a;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        .modal h2 {
            text-align: center;
            color: #FFD700;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            gap: 10px;
        }

        .modal-buttons button, .modal-input-group button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        .modal-buttons .confirm-btn { background-color: #4CAF50; color: white; }
        .modal-buttons .cancel-btn { background-color: #f44336; color: white; }
        .modal-buttons .default-btn { background-color: #008CBA; color: white; }

        .modal-buttons .confirm-btn:hover { background-color: #45a049; }
        .modal-buttons .cancel-btn:hover { background-color: #da190b; }
        .modal-buttons .default-btn:hover { background-color: #007bb5; }

        /* Player Modal specific */
        .modal-input-group {
            margin-bottom: 15px;
            text-align: center;
        }
        .modal-input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        .modal-input-group input[type="number"],
        .modal-input-group input[type="text"],
        .modal-input-group select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: white;
            font-size: 1em;
        }
        .modal-input-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .sanction-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .sanction-options button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: background-color 0.2s;
            color: #1a1a1a;
        }
        .sanction-options .yellow-card-btn { background-color: yellow; }
        .sanction-options .two-min-btn { background-color: orange; }
        .sanction-options .red-card-btn { background-color: red; color: white; }
        .sanction-options .blue-card-btn { background-color: blue; color: white; }

        /* Journal Modal specific */
        .journal-entries {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 10px;
            background-color: #1a1a1a;
            margin-bottom: 15px;
            color: #eee;
        }
        .journal-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
        }
        .journal-entry:last-child {
            border-bottom: none;
        }
        .journal-entry strong {
            color: #FFD700;
        }

        /* Settings Modal specific */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .settings-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .settings-item label {
            font-size: 0.9em;
            color: #bbb;
        }
        .settings-item input[type="number"],
        .settings-item input[type="text"],
        .settings-item select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #333;
            color: white;
            font-size: 0.9em;
        }
        .settings-item input[type="color"] {
            width: 100%;
            height: 35px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .settings-item.two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            align-items: center;
        }
        .settings-item.two-columns label {
            grid-column: 1 / 3; /* Label spans both columns */
        }
        .settings-item.two-columns input {
            width: auto; /* Allow input to fit grid column */
        }


    </style>
</head>
<body>
    <div class="container">
        <div class="main-timer-section">
            <div class="period-info" id="periodInfo">1√®re p√©riode</div>
            <div class="timer" id="mainTimer">
                <span id="minutes">00</span><span class="timer-separator">:</span><span id="seconds">00</span>
            </div>
            <div class="timer-buttons">
                <button id="startPauseBtn">D√©marrer</button>
                <button id="nextPeriodBtn">P√©riode Suivante</button>
                <button id="resetTimerBtn">R√©initialiser Chrono</button>
            </div>
            <div id="timeoutBanner" class="banner banner-timeout">TEMPS MORT</div>
            <div id="pauseBanner" class="banner banner-pause">PAUSE</div>
        </div>

        <div class="team-section team-section-left">
            <div class="team-card team-1-card">
                <div class="team-header">
                    <span class="team-name" id="team1Name">√âquipe 1</span>
                    <div class="score-control">
                        <button class="score-button" id="score1Minus">-</button>
                        <span class="score" id="score1">0</span>
                        <button class="score-button" id="score1Plus">+</button>
                    </div>
                </div>
                <div class="sanctions-timeouts">
                    <button class="sanction-button yellow-card" id="yellowCard1">CJ</button>
                    <button class="sanction-button two-min-exclusion" id="twoMinExclusion1">2min</button>
                    <button class="sanction-button red-card" id="redCard1">CR</button>
                    <button class="sanction-button blue-card" id="blueCard1">CB</button>
                    <button class="timeout-button" id="timeout1Btn">TM</button>
                </div>
                <div class="timeouts-taken" id="timeoutsTaken1">Temps Morts: 0/3</div>
                <div class="sanction-list" id="team1Sanctions">
                    </div>
            </div>
        </div>

        <div class="team-section team-section-right">
            <div class="team-card team-2-card">
                <div class="team-header">
                    <span class="team-name" id="team2Name">√âquipe 2</span>
                    <div class="score-control">
                        <button class="score-button" id="score2Minus">-</button>
                        <span class="score" id="score2">0</span>
                        <button class="score-button" id="score2Plus">+</button>
                    </div>
                </div>
                <div class="sanctions-timeouts">
                    <button class="sanction-button yellow-card" id="yellowCard2">CJ</button>
                    <button class="sanction-button two-min-exclusion" id="twoMinExclusion2">2min</button>
                    <button class="sanction-button red-card" id="redCard2">CR</button>
                    <button class="sanction-button blue-card" id="blueCard2">CB</button>
                    <button class="timeout-button" id="timeout2Btn">TM</button>
                </div>
                <div class="timeouts-taken" id="timeoutsTaken2">Temps Morts: 0/3</div>
                <div class="sanction-list" id="team2Sanctions">
                    </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button id="openJournalModalBtn">
                <span class="icon">üìÑ</span> Journal
            </button>
            <button id="openSettingsModalBtn">
                <span class="icon">‚öôÔ∏è</span> Param√®tres
            </button>
            <button id="fullScreenBtn">
                <span class="icon">‚ÜîÔ∏è</span> Full Screen
            </button>
            <button id="resetMatchBtn">
                <span class="icon">üîÅ</span> Reset
            </button>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="resetModal">&times;</span>
            <h2>R√©initialiser le match ?</h2>
            <p style="text-align: center; margin-bottom: 20px;">Voulez-vous sauvegarder le journal avant de r√©initialiser ?</p>
            <div class="modal-buttons">
                <button class="confirm-btn" id="saveAndResetBtn">Sauvegarder & R√©initialiser</button>
                <button class="cancel-btn" id="resetWithoutSaveBtn">R√©initialiser seulement</button>
                <button class="default-btn" data-modal="resetModal">Annuler</button>
            </div>
        </div>
    </div>

    <div id="playerModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="playerModal">&times;</span>
            <h2 id="playerModalTitle">Appliquer une sanction</h2>
            <div class="modal-input-group">
                <label for="playerNumberInput">Num√©ro du joueur:</label>
                <input type="number" id="playerNumberInput" placeholder="Ex: 7" min="1">
            </div>
            <div class="sanction-options">
                <button class="sanction-options yellow-card-btn" id="playerYellowCardBtn">Carton Jaune</button>
                <button class="sanction-options two-min-btn" id="playerTwoMinBtn">2 minutes</button>
                <button class="sanction-options red-card-btn" id="playerRedCardBtn">Carton Rouge</button>
                <button class="sanction-options blue-card-btn" id="playerBlueCardBtn">Carton Bleu</button>
            </div>
        </div>
    </div>

    <div id="journalModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="journalModal">&times;</span>
            <h2>Journal du match</h2>
            <div class="journal-entries" id="journalEntries">
                </div>
            <div class="modal-buttons">
                <button class="default-btn" id="saveJournalBtn">Sauvegarder le Journal (TXT)</button>
                <button class="confirm-btn" id="clearJournalBtn">Vider le Journal</button>
                <button class="cancel-btn" data-modal="journalModal">Fermer</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="settingsModal">&times;</span>
            <h2>Param√®tres du match</h2>
            <div class="settings-grid">
                <div class="settings-item">
                    <label for="team1NameSetting">Nom √âquipe 1:</label>
                    <input type="text" id="team1NameSetting" value="√âquipe 1">
                </div>
                <div class="settings-item">
                    <label for="team1ColorSetting">Couleur √âquipe 1:</label>
                    <input type="color" id="team1ColorSetting" value="#00BFFF"> </div>
                <div class="settings-item">
                    <label for="team2NameSetting">Nom √âquipe 2:</label>
                    <input type="text" id="team2NameSetting" value="√âquipe 2">
                </div>
                <div class="settings-item">
                    <label for="team2ColorSetting">Couleur √âquipe 2:</label>
                    <input type="color" id="team2ColorSetting" value="#FF4500"> </div>
                <div class="settings-item">
                    <label for="numPeriodsSetting">Nombre de p√©riodes:</label>
                    <select id="numPeriodsSetting">
                        <option value="2">2 p√©riodes</option>
                        <option value="3">3 p√©riodes</option>
                        <option value="4">4 p√©riodes</option>
                    </select>
                </div>
                <div class="settings-item two-columns">
                    <label>Dur√©e des p√©riodes (MM:SS):</label>
                    <input type="number" id="periodDurationMin" value="30" min="1">
                    <input type="number" id="periodDurationSec" value="00" min="0" max="59">
                </div>
                 <div class="settings-item two-columns">
                    <label>Dur√©e des pauses (MM:SS):</label>
                    <input type="number" id="pauseDurationMin" value="10" min="0">
                    <input type="number" id="pauseDurationSec" value="00" min="0" max="59">
                </div>
                <div class="settings-item">
                    <label for="exclusionDurationSetting">Dur√©e exclusion (secondes):</label>
                    <input type="number" id="exclusionDurationSetting" value="120" min="30">
                </div>
                 <div class="settings-item">
                    <label for="reEnterDisplayDurationSetting">Dur√©e affichage "Rentr√©" (secondes):</label>
                    <input type="number" id="reEnterDisplayDurationSetting" value="10" min="0">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="confirm-btn" id="saveSettingsBtn">Sauvegarder</button>
                <button class="default-btn" id="closeSettingsModalBtn">Fermer</button>
            </div>
        </div>
    </div>


    <script>
        // =========================================================
        // 1. Global State Variables
        // =========================================================
        let gameState = {
            mainTimer: 0, // In seconds
            timerInterval: null,
            isTimerRunning: false,
            currentPeriod: 1,
            numPeriods: 2,
            periodDuration: 30 * 60, // 30 minutes in seconds
            pauseDuration: 10 * 60, // 10 minutes in seconds
            isPaused: false, // True if the main timer is paused for a timeout or break
            isBreak: false, // True if it's a period break
            breakTimer: 0, // Timer for breaks between periods

            team1: {
                name: "√âquipe 1",
                score: 0,
                timeoutsTaken: 0,
                yellowCards: [], // Array of player numbers
                redCards: [],
                blueCards: [],
                exclusions: [], // [{ player: num, startTime: Date.now(), duration: 120, timerId: intervalId, status: 'active'/'inactive'/'finished' }]
                color: "#00BFFF" // DeepSkyBlue
            },
            team2: {
                name: "√âquipe 2",
                score: 0,
                timeoutsTaken: 0,
                yellowCards: [],
                redCards: [],
                blueCards: [],
                exclusions: [],
                color: "#FF4500" // OrangeRed
            },
            journal: [], // [{ timestamp: Date, entry: "text" }]
            exclusionDuration: 120, // Default 2 minutes
            reEnterDisplayDuration: 10 // Default 10 seconds for "Rentr√©e" display
        };

        // =========================================================
        // 2. DOM Elements
        // =========================================================
        const mainTimerDisplay = document.getElementById('mainTimer');
        const minutesDisplay = document.getElementById('minutes');
        const secondsDisplay = document.getElementById('seconds');
        const periodInfoDisplay = document.getElementById('periodInfo');
        const startPauseBtn = document.getElementById('startPauseBtn');
        const nextPeriodBtn = document.getElementById('nextPeriodBtn');
        const resetTimerBtn = document.getElementById('resetTimerBtn');

        const team1NameDisplay = document.getElementById('team1Name');
        const score1Display = document.getElementById('score1');
        const score1PlusBtn = document.getElementById('score1Plus');
        const score1MinusBtn = document.getElementById('score1Minus');
        const timeout1Btn = document.getElementById('timeout1Btn');
        const timeoutsTaken1Display = document.getElementById('timeoutsTaken1');
        const team1SanctionsDisplay = document.getElementById('team1Sanctions');

        const team2NameDisplay = document.getElementById('team2Name');
        const score2Display = document.getElementById('score2');
        const score2PlusBtn = document.getElementById('score2Plus');
        const score2MinusBtn = document.getElementById('score2Minus');
        const timeout2Btn = document.getElementById('timeout2Btn');
        const timeoutsTaken2Display = document.getElementById('timeoutsTaken2');
        const team2SanctionsDisplay = document.getElementById('team2Sanctions');

        const timeoutBanner = document.getElementById('timeoutBanner');
        const pauseBanner = document.getElementById('pauseBanner');

        // Modals
        const resetModal = document.getElementById('resetModal');
        const saveAndResetBtn = document.getElementById('saveAndResetBtn');
        const resetWithoutSaveBtn = document.getElementById('resetWithoutSaveBtn');
        const resetMatchBtn = document.getElementById('resetMatchBtn'); // From bottom nav

        const playerModal = document.getElementById('playerModal');
        const playerModalTitle = document.getElementById('playerModalTitle');
        const playerNumberInput = document.getElementById('playerNumberInput');
        const yellowCardBtn = document.getElementById('playerYellowCardBtn');
        const twoMinBtn = document.getElementById('playerTwoMinBtn');
        const redCardBtn = document.getElementById('playerRedCardBtn');
        const blueCardBtn = document.getElementById('playerBlueCardBtn');

        const journalModal = document.getElementById('journalModal');
        const journalEntriesDisplay = document.getElementById('journalEntries');
        const openJournalModalBtn = document.getElementById('openJournalModalBtn');
        const saveJournalBtn = document.getElementById('saveJournalBtn');
        const clearJournalBtn = document.getElementById('clearJournalBtn');

        const settingsModal = document.getElementById('settingsModal');
        const openSettingsModalBtn = document.getElementById('openSettingsModalBtn');
        const team1NameSetting = document.getElementById('team1NameSetting');
        const team1ColorSetting = document.getElementById('team1ColorSetting');
        const team2NameSetting = document.getElementById('team2NameSetting');
        const team2ColorSetting = document.getElementById('team2ColorSetting');
        const numPeriodsSetting = document.getElementById('numPeriodsSetting');
        const periodDurationMin = document.getElementById('periodDurationMin');
        const periodDurationSec = document.getElementById('periodDurationSec');
        const pauseDurationMin = document.getElementById('pauseDurationMin');
        const pauseDurationSec = document.getElementById('pauseDurationSec');
        const exclusionDurationSetting = document.getElementById('exclusionDurationSetting');
        const reEnterDisplayDurationSetting = document.getElementById('reEnterDisplayDurationSetting');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');

        const fullScreenBtn = document.getElementById('fullScreenBtn');


        // =========================================================
        // 3. Utility Functions
        // =========================================================

        /**
         * Formats seconds into MM:SS format.
         * @param {number} totalSeconds - The total number of seconds.
         * @returns {string} Formatted time string (MM:SS).
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /**
         * Triggers a short vibration if supported.
         */
        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate(100); // Vibrate for 100ms
            }
        }

        /**
         * Converts an RGB color string to its hexadecimal equivalent.
         * Useful for saving color pickers' values consistently.
         * @param {string} rgb - RGB color string (e.g., "rgb(0, 191, 255)").
         * @returns {string} Hexadecimal color string (e.g., "#00BFFF").
         */
        function rgbToHex(rgb) {
            // Choose the RGB format that matches your input
            const parts = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!parts) {
                // If not RGB, assume it's already hex or a named color and return as is
                return rgb; 
            }
            delete parts[0];
            for (let i = 1; i <= 3; ++i) {
                parts[i] = parseInt(parts[i]).toString(16);
                if (parts[i].length === 1) parts[i] = '0' + parts[i];
            }
            return '#' + parts.join('');
        }

        /**
         * Adds an event to the match journal.
         * @param {string} entryText - The text description of the event.
         */
        function addToJournal(entryText) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const currentFormattedTime = formatTime(gameState.mainTimer);

            // Replace team names with colored versions for better readability in journal
            let formattedEntryText = entryText.replace(
                new RegExp(escapeRegExp(gameState.team1.name), 'g'), 
                `<span style="color:${gameState.team1.color}; font-weight:bold;">${gameState.team1.name}</span>`
            ).replace(
                new RegExp(escapeRegExp(gameState.team2.name), 'g'), 
                `<span style="color:${gameState.team2.color}; font-weight:bold;">${gameState.team2.name}</span>`
            );

            gameState.journal.push({
                timestamp: now.toISOString(), // ISO for sorting/saving
                displayTime: currentFormattedTime,
                entry: formattedEntryText // Store formatted text for display
            });
            updateJournalDisplay();
            saveGameState(); // Save state after adding to journal
        }
        
        // Helper for addToJournal to escape regex special characters
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the matched substring
        }

        /**
         * Updates the main timer display and period info.
         */
        function updateDisplay() {
            minutesDisplay.textContent = String(Math.floor(gameState.mainTimer / 60)).padStart(2, '0');
            secondsDisplay.textContent = String(gameState.mainTimer % 60).padStart(2, '0');

            periodInfoDisplay.textContent = `P√©riode ${gameState.currentPeriod}/${gameState.numPeriods}`;

            team1NameDisplay.textContent = gameState.team1.name;
            team1NameDisplay.style.color = gameState.team1.color;
            score1Display.textContent = gameState.team1.score;
            timeoutsTaken1Display.textContent = `Temps Morts: ${gameState.team1.timeoutsTaken}/3`;

            team2NameDisplay.textContent = gameState.team2.name;
            team2NameDisplay.style.color = gameState.team2.color;
            score2Display.textContent = gameState.team2.score;
            timeoutsTaken2Display.textContent = `Temps Morts: ${gameState.team2.timeoutsTaken}/3`;

            updateSanctionDisplays();
            updateBanners();
        }

        /**
         * Displays/hides timeout and pause banners.
         */
        function updateBanners() {
            if (gameState.isPaused && !gameState.isBreak) {
                timeoutBanner.classList.add('active');
                pauseBanner.classList.remove('active');
            } else if (gameState.isBreak) {
                pauseBanner.classList.add('active');
                timeoutBanner.classList.remove('active');
            } else {
                timeoutBanner.classList.remove('active');
                pauseBanner.classList.remove('active');
            }
        }


        // =========================================================
        // 4. Timer Logic
        // =========================================================

        /**
         * Starts or pauses the main game timer.
         */
        function toggleTimer() {
            if (gameState.isTimerRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        /**
         * Starts the main game timer or break timer.
         */
        function startTimer() {
            if (gameState.timerInterval) return; // Prevent multiple intervals

            gameState.isTimerRunning = true;
            startPauseBtn.textContent = 'Pause';
            startPauseBtn.style.backgroundColor = '#f44336'; // Red for Pause

            // Clear any active banners
            timeoutBanner.classList.remove('active');
            pauseBanner.classList.remove('active');

            addToJournal(`Chrono ${gameState.isBreak ? 'pause' : 'match'} d√©marr√©`);

            gameState.timerInterval = setInterval(() => {
                if (gameState.isBreak) {
                    // Handle break timer
                    if (gameState.breakTimer > 0) {
                        gameState.breakTimer--;
                        minutesDisplay.textContent = String(Math.floor(gameState.breakTimer / 60)).padStart(2, '0');
                        secondsDisplay.textContent = String(gameState.breakTimer % 60).padStart(2, '0');
                    } else {
                        // End of break
                        pauseTimer();
                        vibrate();
                        addToJournal(`Fin de la pause entre les p√©riodes.`);
                        if (gameState.currentPeriod <= gameState.numPeriods) {
                            periodInfoDisplay.textContent = `P√©riode ${gameState.currentPeriod}/${gameState.numPeriods}`;
                        }
                        gameState.isBreak = false; // Reset break state
                        // The main timer will resume if startPauseBtn is pressed
                    }
                } else {
                    // Handle main game timer
                    if (gameState.mainTimer < gameState.periodDuration) {
                        gameState.mainTimer++;
                        updateDisplay();
                    } else {
                        // End of period
                        pauseTimer();
                        vibrate();
                        addToJournal(`Fin de la ${gameState.currentPeriod}√®re p√©riode.`);
                        gameState.currentPeriod++;
                        
                        if (gameState.currentPeriod <= gameState.numPeriods) {
                            // Start a break
                            gameState.isBreak = true;
                            gameState.breakTimer = gameState.pauseDuration;
                            periodInfoDisplay.textContent = `PAUSE (P√©riode ${gameState.currentPeriod - 1}/${gameState.numPeriods} termin√©e)`;
                            pauseBanner.classList.add('active');
                            startPauseBtn.textContent = 'D√©marrer Pause';
                            startPauseBtn.style.backgroundColor = '#008CBA'; // Blue for Start Pause
                            addToJournal(`D√©but de la pause avant la ${gameState.currentPeriod}√®me p√©riode.`);
                        } else {
                            // End of match
                            periodInfoDisplay.textContent = 'Match Termin√©';
                            addToJournal('Match Termin√©.');
                            startPauseBtn.textContent = 'Match Termin√©';
                            startPauseBtn.disabled = true; // Disable button
                            nextPeriodBtn.disabled = true;
                        }
                    }
                }
                updateExclusionTimers();
                saveGameState(); // Save state on each second
            }, 1000);
        }

        /**
         * Pauses the current timer.
         */
        function pauseTimer() {
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = null;
            gameState.isTimerRunning = false;
            startPauseBtn.textContent = 'D√©marrer';
            startPauseBtn.style.backgroundColor = '#4CAF50'; // Green for Start

            addToJournal(`Chrono ${gameState.isBreak ? 'pause' : 'match'} mis en pause.`);
            updateBanners(); // Display appropriate banner if paused manually
            saveGameState();
        }

        /**
         * Advances to the next period or finishes the match.
         */
        function nextPeriod() {
            vibrate();
            pauseTimer(); // Always pause before moving to next period

            if (gameState.currentPeriod < gameState.numPeriods) {
                addToJournal(`Passage √† la ${gameState.currentPeriod + 1}√®me p√©riode. Fin de la ${gameState.currentPeriod}√®re p√©riode.`);
                
                gameState.currentPeriod++;
                gameState.mainTimer = 0; // Reset main timer for new period
                
                // Start a break before the new period
                gameState.isBreak = true;
                gameState.breakTimer = gameState.pauseDuration;
                periodInfoDisplay.textContent = `PAUSE (P√©riode ${gameState.currentPeriod - 1}/${gameState.numPeriods} termin√©e)`;
                pauseBanner.classList.add('active');
                startPauseBtn.textContent = 'D√©marrer Pause';
                startPauseBtn.style.backgroundColor = '#008CBA'; // Blue for Start Pause
                addToJournal(`D√©but de la pause avant la ${gameState.currentPeriod}√®me p√©riode.`);

            } else {
                addToJournal('Match Termin√©.');
                gameState.mainTimer = gameState.periodDuration; // Ensure timer shows full duration
                periodInfoDisplay.textContent = 'Match Termin√©';
                startPauseBtn.textContent = 'Match Termin√©';
                startPauseBtn.disabled = true;
                nextPeriodBtn.disabled = true;
                gameState.isTimerRunning = false;
                pauseBanner.classList.remove('active'); // No pause banner for match end
            }
            updateDisplay();
            saveGameState();
        }

        /**
         * Resets the main timer to 0 for the current period.
         */
        function resetMainTimer() {
            vibrate();
            pauseTimer();
            gameState.mainTimer = 0;
            addToJournal(`Chrono principal r√©initialis√© pour la ${gameState.currentPeriod}√®me p√©riode.`);
            updateDisplay();
            saveGameState();
        }

        // =========================================================
        // 5. Score and Timeout Logic
        // =========================================================

        /**
         * Adjusts the score for a given team.
         * @param {number} teamId - 1 for team1, 2 for team2.
         * @param {number} delta - +1 to increment, -1 to decrement.
         */
        function adjustScore(teamId, delta) {
            vibrate();
            const team = teamId === 1 ? gameState.team1 : gameState.team2;
            const teamName = teamId === 1 ? gameState.team1.name : gameState.team2.name;
            const oldScore = team.score;
            team.score = Math.max(0, team.score + delta); // Score cannot go below 0
            if (delta > 0) {
                addToJournal(`But pour ${teamName} (${team.score} - ${teamId === 1 ? gameState.team2.score : gameState.team1.score}).`);
            } else if (team.score < oldScore) {
                 addToJournal(`Score de ${teamName} diminu√© (${team.score} - ${teamId === 1 ? gameState.team2.score : gameState.team1.score}).`);
            }
            updateDisplay();
            saveGameState();
        }

        /**
         * Registers a timeout for a given team.
         * @param {number} teamId - 1 for team1, 2 for team2.
         */
        function registerTimeout(teamId) {
            vibrate();
            const team = teamId === 1 ? gameState.team1 : gameState.team2;
            const teamName = teamId === 1 ? gameState.team1.name : gameState.team2.name;

            if (team.timeoutsTaken < 3) {
                pauseTimer(); // Pause main timer for timeout
                gameState.isPaused = true;
                team.timeoutsTaken++;
                addToJournal(`Temps mort demand√© par ${teamName}. ${team.timeoutsTaken}/3 pris.`);
                updateDisplay();
            } else {
                alert(`L'√©quipe ${teamName} n'a plus de temps morts disponibles.`);
                addToJournal(`Tentative de temps mort par ${teamName} (aucun disponible).`);
            }
            saveGameState();
        }

        // =========================================================
        // 6. Sanction Logic (Cards & Exclusions)
        // =========================================================

        let currentSanctionTeamId = null; // Store which team is active for player modal

        /**
         * Opens the player modal to apply a sanction.
         * @param {number} teamId - 1 for team1, 2 for team2.
         * @param {string} sanctionType - 'yellow', 'two_min', 'red', 'blue'.
         */
        function openPlayerModal(teamId, sanctionType) {
            currentSanctionTeamId = teamId;
            playerModal.classList.add('active');
            playerNumberInput.value = ''; // Clear previous input

            // Hide/show sanction buttons based on the requested sanctionType
            yellowCardBtn.style.display = 'none';
            twoMinBtn.style.display = 'none';
            redCardBtn.style.display = 'none';
            blueCardBtn.style.display = 'none';

            playerModalTitle.textContent = `Appliquer ${getSanctionDisplayName(sanctionType)} pour ${teamId === 1 ? gameState.team1.name : gameState.team2.name}`;

            if (sanctionType === 'yellow') yellowCardBtn.style.display = 'inline-block';
            if (sanctionType === 'two_min') twoMinBtn.style.display = 'inline-block';
            if (sanctionType === 'red') redCardBtn.style.display = 'inline-block';
            if (sanctionType === 'blue') blueCardBtn.style.display = 'inline-block';
        }

        /**
         * Gets a display name for a sanction type.
         * @param {string} sanctionType - 'yellow', 'two_min', 'red', 'blue'.
         * @returns {string} The display name.
         */
        function getSanctionDisplayName(sanctionType) {
            switch (sanctionType) {
                case 'yellow': return 'un Carton Jaune';
                case 'two_min': return 'une Exclusion de 2 minutes';
                case 'red': return 'un Carton Rouge';
                case 'blue': return 'un Carton Bleu';
                default: return 'une sanction';
            }
        }

        /**
         * Applies the selected sanction to the specified player.
         * @param {string} type - 'yellow', 'two_min', 'red', 'blue'.
         */
        function applySanction(type) {
            const playerNum = parseInt(playerNumberInput.value, 10);
            if (isNaN(playerNum) || playerNum <= 0) {
                alert('Veuillez entrer un num√©ro de joueur valide.');
                return;
            }

            vibrate();
            const team = currentSanctionTeamId === 1 ? gameState.team1 : gameState.team2;
            const teamName = currentSanctionTeamId === 1 ? gameState.team1.name : gameState.team2.name;
            const timeApplied = formatTime(gameState.mainTimer);

            switch (type) {
                case 'yellow':
                    if (!team.yellowCards.includes(playerNum)) {
                        team.yellowCards.push(playerNum);
                        addToJournal(`Carton jaune pour le joueur ${playerNum} de ${teamName} √† ${timeApplied}.`);
                    } else {
                        alert(`Le joueur ${playerNum} de ${teamName} a d√©j√† un carton jaune.`);
                    }
                    break;
                case 'two_min':
                    addTwoMinuteExclusion(currentSanctionTeamId, playerNum);
                    addToJournal(`Exclusion de 2 minutes pour le joueur ${playerNum} de ${teamName} √† ${timeApplied}.`);
                    break;
                case 'red':
                    if (!team.redCards.includes(playerNum)) {
                        team.redCards.push(playerNum);
                        addToJournal(`Carton rouge pour le joueur ${playerNum} de ${teamName} √† ${timeApplied}.`);
                    } else {
                        alert(`Le joueur ${playerNum} de ${teamName} a d√©j√† un carton rouge.`);
                    }
                    break;
                case 'blue':
                    if (!team.blueCards.includes(playerNum)) {
                        team.blueCards.push(playerNum);
                        addToJournal(`Carton bleu pour le joueur ${playerNum} de ${teamName} √† ${timeApplied}.`);
                    } else {
                        alert(`Le joueur ${playerNum} de ${teamName} a d√©j√† un carton bleu.`);
                    }
                    break;
            }
            closeModal();
            updateDisplay();
            saveGameState();
        }

        /**
         * Adds a 2-minute exclusion for a player.
         * @param {number} teamId - 1 for team1, 2 for team2.
         * @param {number} playerNum - The player number.
         */
        function addTwoMinuteExclusion(teamId, playerNum) {
            const team = teamId === 1 ? gameState.team1 : gameState.team2;
            // Check if player is already under 2-min exclusion
            const existingExclusion = team.exclusions.find(ex => ex.player === playerNum && ex.status === 'active');
            if (existingExclusion) {
                alert(`Le joueur ${playerNum} de ${team.name} est d√©j√† en cours d'exclusion.`);
                return;
            }

            const exclusion = {
                player: playerNum,
                remainingTime: gameState.exclusionDuration,
                duration: gameState.exclusionDuration, // Store original duration
                status: 'active', // 'active', 'inactive' (during pause), 'finished'
                reEnterTimer: 0 // Used for "Rentr√©e" display
            };
            team.exclusions.push(exclusion);

            // Update exclusion timers immediately
            updateExclusionTimers();
        }

        /**
         * Updates all active 2-minute exclusion timers.
         */
        function updateExclusionTimers() {
            [gameState.team1, gameState.team2].forEach(team => {
                team.exclusions.forEach(exclusion => {
                    if (exclusion.status === 'active') {
                        if (gameState.isTimerRunning && !gameState.isBreak) { // Only count down if main timer is running and not in break
                            exclusion.remainingTime--;
                        }

                        if (exclusion.remainingTime <= 0) {
                            exclusion.remainingTime = 0;
                            if (exclusion.status !== 'finished') { // Only log once
                                exclusion.status = 'finished';
                                exclusion.reEnterTimer = gameState.reEnterDisplayDuration; // Start "Rentr√©e" timer
                                addToJournal(`Le joueur ${exclusion.player} de ${team.name} a purg√© sa peine de 2 minutes.`);
                                vibrate();
                            }
                        }
                    }

                    if (exclusion.status === 'finished' && exclusion.reEnterTimer > 0) {
                        if (gameState.isTimerRunning && !gameState.isBreak) {
                            exclusion.reEnterTimer--;
                        }
                    }
                });
            });
            renderExclusionTimers();
        }


        /**
         * Renders the 2-minute exclusion timers in the UI.
         */
        function renderExclusionTimers() {
            [
                { team: gameState.team1, display: team1SanctionsDisplay },
                { team: gameState.team2, display: team2SanctionsDisplay }
            ].forEach(({ team, display }) => {
                display.innerHTML = ''; // Clear current display

                // Sort exclusions by remaining time (ascending) and then player number
                const sortedExclusions = [...team.exclusions].sort((a, b) => {
                    if (a.status === 'finished' && b.status !== 'finished') return 1;
                    if (a.status !== 'finished' && b.status === 'finished') return -1;
                    return a.remainingTime - b.remainingTime || a.player - b.player;
                });


                sortedExclusions.forEach(ex => {
                    const exclusionDiv = document.createElement('div');
                    exclusionDiv.className = 'two-min-timer';
                    if (!gameState.isTimerRunning || gameState.isBreak) {
                        exclusionDiv.classList.add('inactive');
                    } else if (ex.status === 'finished') {
                        exclusionDiv.classList.add('finished');
                    } else {
                        exclusionDiv.classList.add('active');
                    }
                    
                    const playerSpan = document.createElement('span');
                    playerSpan.className = 'player-num';
                    playerSpan.textContent = `#${ex.player}`;
                    exclusionDiv.appendChild(playerSpan);

                    const timerValueSpan = document.createElement('span');
                    timerValueSpan.className = 'timer-value';

                    if (ex.status === 'finished') {
                        if (ex.reEnterTimer > 0) {
                             timerValueSpan.textContent = `Rentr√© (${ex.reEnterTimer}s)`;
                        } else {
                            timerValueSpan.textContent = 'Rentr√©';
                            exclusionDiv.style.opacity = 0.5; // Dim finished and cleared timers
                        }
                    } else {
                        timerValueSpan.textContent = formatTime(ex.remainingTime);
                    }
                    exclusionDiv.appendChild(timerValueSpan);
                    display.appendChild(exclusionDiv);
                });
            });
        }


        /**
         * Removes a sanction (only yellow, red, blue cards for now).
         * For 2-min, the timer runs out.
         * @param {number} teamId - The team ID.
         * @param {string} type - 'yellow', 'red', 'blue'.
         * @param {number} playerNum - The player number to remove.
         */
        // This function is not currently hooked to the UI but could be for future features.
        // function removeSanction(teamId, type, playerNum) {
        //     const team = teamId === 1 ? gameState.team1 : gameState.team2;
        //     let index;
        //     switch (type) {
        //         case 'yellow':
        //             index = team.yellowCards.indexOf(playerNum);
        //             if (index > -1) team.yellowCards.splice(index, 1);
        //             break;
        //         case 'red':
        //             index = team.redCards.indexOf(playerNum);
        //             if (index > -1) team.redCards.splice(index, 1);
        //             break;
        //         case 'blue':
        //             index = team.blueCards.indexOf(playerNum);
        //             if (index > -1) team.blueCards.splice(index, 1);
        //             break;
        //     }
        //     addToJournal(`Sanction (${type}) retir√©e pour joueur ${playerNum} de ${team.name}.`);
        //     updateDisplay();
        //     saveGameState();
        // }


        // =========================================================
        // 7. Modal Control
        // =========================================================

        /**
         * Opens a specified modal.
         * @param {HTMLElement} modalElement - The modal DOM element to open.
         */
        function openModal(modalElement) {
            modalElement.classList.add('active');
            // Check if it's the journal modal to refresh its content
            if (modalElement === journalModal) {
                updateJournalDisplay();
            } else if (modalElement === settingsModal) {
                loadSettingsIntoModal();
            }
        }

        /**
         * Closes a specified modal or the currently active one.
         * @param {HTMLElement} [modalElement] - Optional. The modal DOM element to close.
         * If not provided, finds the active modal.
         */
        function closeModal(modalElement = null) {
            if (!modalElement) {
                modalElement = document.querySelector('.modal.active');
            }
            if (modalElement) {
                modalElement.classList.remove('active');
            }
        }

        // =========================================================
        // 8. Journal Management
        // =========================================================

        /**
         * Updates the journal display in the modal.
         */
        function updateJournalDisplay() {
            journalEntriesDisplay.innerHTML = '';
            // Display entries in reverse chronological order
            [...gameState.journal].reverse().forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'journal-entry';
                entryDiv.innerHTML = `[${entry.displayTime}] ${entry.entry}`;
                journalEntriesDisplay.appendChild(entryDiv);
            });
        }

        /**
         * Saves the journal to a text file.
         */
        function saveJournal() {
            const fileName = `Journal_Match_${gameState.team1.name}_vs_${gameState.team2.name}_${new Date().toISOString().slice(0, 10)}.txt`;
            const header = `--- Journal du Match ${gameState.team1.name} vs ${gameState.team2.name} ---\n`;
            const initialScore = `Score initial: ${gameState.team1.score} - ${gameState.team2.score}\n`;
            const finalScore = `Score final: ${gameState.team1.score} - ${gameState.team2.score}\n`;
            
            const journalContent = gameState.journal.map(entry => {
                // Remove HTML tags for the text file
                const cleanedEntry = entry.entry.replace(/<[^>]*>/g, ''); 
                return `[${entry.displayTime}] ${cleanedEntry}`;
            }).join('\n');

            const fullContent = `${header}\n${journalContent}\n\n${finalScore}`;
            
            const blob = new Blob([fullContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            addToJournal('Journal sauvegard√© en fichier texte.');
        }

        /**
         * Clears all entries from the journal.
         */
        function clearJournal() {
            if (confirm('√ätes-vous s√ªr de vouloir vider le journal ? Cette action est irr√©versible.')) {
                gameState.journal = [];
                updateJournalDisplay();
                addToJournal('Journal vid√©.');
                saveGameState();
            }
        }

        // =========================================================
        // 9. Settings Management
        // =========================================================

        /**
         * Loads current game state settings into the settings modal.
         */
        function loadSettingsIntoModal() {
            team1NameSetting.value = gameState.team1.name;
            team1ColorSetting.value = gameState.team1.color;
            team2NameSetting.value = gameState.team2.name;
            team2ColorSetting.value = gameState.team2.color;
            numPeriodsSetting.value = gameState.numPeriods;
            periodDurationMin.value = Math.floor(gameState.periodDuration / 60);
            periodDurationSec.value = gameState.periodDuration % 60;
            pauseDurationMin.value = Math.floor(gameState.pauseDuration / 60);
            pauseDurationSec.value = gameState.pauseDuration % 60;
            exclusionDurationSetting.value = gameState.exclusionDuration;
            reEnterDisplayDurationSetting.value = gameState.reEnterDisplayDuration;
        }

        /**
         * Saves settings from the modal to the game state.
         */
        function saveSettings() {
            vibrate();
            const oldTeam1Name = gameState.team1.name;
            const oldTeam2Name = gameState.team2.name;

            gameState.team1.name = team1NameSetting.value;
            gameState.team1.color = rgbToHex(team1ColorSetting.value);
            gameState.team2.name = team2NameSetting.value;
            gameState.team2.color = rgbToHex(team2ColorSetting.value);
            
            // Update journal entries with new team names
            gameState.journal.forEach(entry => {
                entry.entry = entry.entry
                    .replace(new RegExp(escapeRegExp(oldTeam1Name), 'g'), `<span style="color:${gameState.team1.color}; font-weight:bold;">${gameState.team1.name}</span>`)
                    .replace(new RegExp(escapeRegExp(oldTeam2Name), 'g'), `<span style="color:${gameState.team2.color}; font-weight:bold;">${gameState.team2.name}</span>`);
            });


            gameState.numPeriods = parseInt(numPeriodsSetting.value, 10);
            gameState.periodDuration = (parseInt(periodDurationMin.value, 10) * 60) + parseInt(periodDurationSec.value, 10);
            gameState.pauseDuration = (parseInt(pauseDurationMin.value, 10) * 60) + parseInt(pauseDurationSec.value, 10);
            gameState.exclusionDuration = parseInt(exclusionDurationSetting.value, 10);
            gameState.reEnterDisplayDuration = parseInt(reEnterDisplayDurationSetting.value, 10);

            updateTeamColorsDisplay(); // Update team name colors immediately
            updateDisplay();
            closeModal();
            addToJournal('Param√®tres du match mis √† jour.');
            saveGameState();
        }

        /**
         * Updates the team name colors in the main display based on saved settings.
         */
        function updateTeamColorsDisplay() {
            team1NameDisplay.style.color = gameState.team1.color;
            team2NameDisplay.style.color = gameState.team2.color;
        }


        // =========================================================
        // 10. Reset Game State
        // =========================================================

        /**
         * Resets the entire game state to initial values.
         */
        function resetGame() {
            vibrate();
            pauseTimer(); // Ensure timer is stopped
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = null;

            gameState = {
                mainTimer: 0,
                timerInterval: null,
                isTimerRunning: false,
                currentPeriod: 1,
                numPeriods: parseInt(numPeriodsSetting.value, 10) || 2, // Use setting default
                periodDuration: (parseInt(periodDurationMin.value, 10) * 60) + parseInt(periodDurationSec.value, 10) || 30 * 60,
                pauseDuration: (parseInt(pauseDurationMin.value, 10) * 60) + parseInt(pauseDurationSec.value, 10) || 10 * 60,
                isPaused: false,
                isBreak: false,
                breakTimer: 0,
                team1: {
                    name: team1NameSetting.value || "√âquipe 1",
                    score: 0,
                    timeoutsTaken: 0,
                    yellowCards: [],
                    redCards: [],
                    blueCards: [],
                    exclusions: [],
                    color: team1ColorSetting.value || "#00BFFF"
                },
                team2: {
                    name: team2NameSetting.value || "√âquipe 2",
                    score: 0,
                    timeoutsTaken: 0,
                    yellowCards: [],
                    redCards: [],
                    blueCards: [],
                    exclusions: [],
                    color: team2ColorSetting.value || "#FF4500"
                },
                journal: [],
                exclusionDuration: parseInt(exclusionDurationSetting.value, 10) || 120,
                reEnterDisplayDuration: parseInt(reEnterDisplayDurationSetting.value, 10) || 10
            };

            // Re-enable buttons
            startPauseBtn.disabled = false;
            startPauseBtn.textContent = 'D√©marrer';
            startPauseBtn.style.backgroundColor = '#4CAF50';
            nextPeriodBtn.disabled = false;

            addToJournal('Match r√©initialis√©.');
            updateDisplay(); // Refresh UI with new state
            saveGameState(); // Save initial state
        }

        // =========================================================
        // 11. Full Screen Mode
        // =========================================================
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Erreur pour le mode plein √©cran: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // =========================================================
        // 12. Local Storage (Persistance)
        // =========================================================

        const LOCAL_STORAGE_KEY = 'handballRefereeGameState';

        /**
         * Saves the current game state to Local Storage.
         */
        function saveGameState() {
            try {
                // Remove timerInterval and exclusion timerIds as they cannot be serialized
                const stateToSave = JSON.parse(JSON.stringify(gameState)); // Deep copy
                stateToSave.timerInterval = null; // Clear interval ID
                stateToSave.team1.exclusions.forEach(ex => ex.timerId = null);
                stateToSave.team2.exclusions.forEach(ex => ex.timerId = null);

                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
                // console.log('Game state saved.'); // For debugging
            } catch (e) {
                console.error('Erreur lors de la sauvegarde de l\'√©tat du jeu:', e);
            }
        }

        /**
         * Loads the game state from Local Storage.
         */
        function loadGameState() {
            try {
                const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedState) {
                    const loadedState = JSON.parse(savedState);
                    // Ensure functions/non-serializable parts are not overwritten if they exist
                    // Merge properties carefully, do not just assign directly
                    Object.assign(gameState.team1, loadedState.team1);
                    Object.assign(gameState.team2, loadedState.team2);
                    
                    gameState.mainTimer = loadedState.mainTimer || 0;
                    gameState.isTimerRunning = loadedState.isTimerRunning || false;
                    gameState.currentPeriod = loadedState.currentPeriod || 1;
                    gameState.numPeriods = loadedState.numPeriods || 2;
                    gameState.periodDuration = loadedState.periodDuration || 30 * 60;
                    gameState.pauseDuration = loadedState.pauseDuration || 10 * 60;
                    gameState.isPaused = loadedState.isPaused || false;
                    gameState.isBreak = loadedState.isBreak || false;
                    gameState.breakTimer = loadedState.breakTimer || 0;
                    gameState.journal = loadedState.journal || [];
                    gameState.exclusionDuration = loadedState.exclusionDuration || 120;
                    gameState.reEnterDisplayDuration = loadedState.reEnterDisplayDuration || 10;

                    // Re-start main timer if it was running
                    if (gameState.isTimerRunning) {
                        startTimer();
                    }
                    // Re-start exclusion timers logic (they are handled by the main interval)
                    renderExclusionTimers();

                    console.log('Game state loaded.');
                    return true;
                }
            } catch (e) {
                console.error('Erreur lors du chargement de l\'√©tat du jeu:', e);
            }
            return false;
        }

        /**
         * Clears the saved game state from Local Storage.
         */
        function clearSavedGameState() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            console.log('Game state cleared from Local Storage.');
        }


        // =========================================================
        // 13. Wake Lock API (Prevent Screen Sleep) - NEW
        // =========================================================
        let wakeLock = null; // Variable to store the Wake Lock object

        // Function to request a Wake Lock
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock √©cran activ√©.');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock √©cran rel√¢ch√©.');
                    });
                } catch (err) {
                    console.error(`Erreur de Wake Lock: ${err.name}, ${err.message}`);
                }
            }
        };

        // Function to release the Wake Lock
        const releaseWakeLock = () => {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock √©cran rel√¢ch√© (manuel).');
            }
        };


        // =========================================================
        // 14. Initialization and Event Listeners
        // =========================================================

        function initEventListeners() {
            // Main Timer Controls
            startPauseBtn.addEventListener('click', toggleTimer);
            nextPeriodBtn.addEventListener('click', nextPeriod);
            resetTimerBtn.addEventListener('click', resetMainTimer);

            // Score Controls
            score1PlusBtn.addEventListener('click', () => adjustScore(1, 1));
            score1MinusBtn.addEventListener('click', () => adjustScore(1, -1));
            score2PlusBtn.addEventListener('click', () => adjustScore(2, 1));
            score2MinusBtn.addEventListener('click', () => adjustScore(2, -1));

            // Timeout Buttons
            timeout1Btn.addEventListener('click', () => registerTimeout(1));
            timeout2Btn.addEventListener('click', () => registerTimeout(2));

            // Sanction Buttons
            document.getElementById('yellowCard1').addEventListener('click', () => openPlayerModal(1, 'yellow'));
            document.getElementById('twoMinExclusion1').addEventListener('click', () => openPlayerModal(1, 'two_min'));
            document.getElementById('redCard1').addEventListener('click', () => openPlayerModal(1, 'red'));
            document.getElementById('blueCard1').addEventListener('click', () => openPlayerModal(1, 'blue'));

            document.getElementById('yellowCard2').addEventListener('click', () => openPlayerModal(2, 'yellow'));
            document.getElementById('twoMinExclusion2').addEventListener('click', () => openPlayerModal(2, 'two_min'));
            document.getElementById('redCard2').addEventListener('click', () => openPlayerModal(2, 'red'));
            document.getElementById('blueCard2').addEventListener('click', () => openPlayerModal(2, 'blue'));

            // Player Modal sanction buttons
            yellowCardBtn.addEventListener('click', () => applySanction('yellow'));
            twoMinBtn.addEventListener('click', () => applySanction('two_min'));
            redCardBtn.addEventListener('click', () => applySanction('red'));
            blueCardBtn.addEventListener('click', () => applySanction('blue'));

            // Reset Modal
            resetMatchBtn.addEventListener('click', () => openModal(resetModal));
            saveAndResetBtn.addEventListener('click', () => {
                saveJournal(); // Save journal first
                clearSavedGameState(); // Clear saved state
                resetGame(); // Then reset the game
                closeModal(resetModal);
            });
            resetWithoutSaveBtn.addEventListener('click', () => {
                if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le match SANS sauvegarder le journal ?')) {
                    clearSavedGameState(); // Clear saved state
                    resetGame(); // Then reset the game
                    closeModal(resetModal);
                }
            });

            // Journal Modal
            openJournalModalBtn.addEventListener('click', () => openModal(journalModal));
            saveJournalBtn.addEventListener('click', saveJournal);
            clearJournalBtn.addEventListener('click', clearJournal);

            // Settings Modal
            openSettingsModalBtn.addEventListener('click', () => openModal(settingsModal));
            saveSettingsBtn.addEventListener('click', saveSettings);
            team1NameDisplay.addEventListener('click', () => openModal(settingsModal)); // Click team name to open settings
            team2NameDisplay.addEventListener('click', () => openModal(settingsModal)); // Click team name to open settings


            // Full Screen
            fullScreenBtn.addEventListener('click', toggleFullScreen);

            // Close modals using the 'x' button or by clicking outside
            document.querySelectorAll('.close-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    closeModal(document.getElementById(e.target.dataset.modal));
                });
            });
            document.getElementById('closeSettingsModalBtn').addEventListener('click', closeModal); // Special close for settings modal

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal();
                }
            });

            // Handle Wake Lock when page visibility changes
            document.addEventListener('visibilitychange', () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    requestWakeLock(); // Re-request Wake Lock if we come back to the page
                } else if (document.visibilityState === 'hidden') {
                    releaseWakeLock(); // Release Wake Lock if the page is hidden
                }
            });

            // Release Wake Lock before the page unloads
            window.addEventListener('beforeunload', () => {
                releaseWakeLock();
            });
        }

        // =========================================================
        // 15. Initialization on DOM Load & PWA Registration
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            if (!loadGameState()) { // Try to load saved state, if not successful, initialize defaults
                // Initialize default settings if no saved state
                loadSettingsIntoModal(); 
                // Set initial names & colors
                gameState.team1.name = team1NameSetting.value;
                gameState.team1.color = team1ColorSetting.value;
                gameState.team2.name = team2NameSetting.value;
                gameState.team2.color = team2ColorSetting.value;
                addToJournal('D√©but du match'); // Only add if starting fresh
            } else {
                 // If loaded, ensure settings modal fields reflect loaded state
                loadSettingsIntoModal();
            }
            updateTeamColorsDisplay(); 
            updateDisplay();


            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('Service Worker enregistr√© avec succ√®s:', registration.scope);
                            // Demander le Wake Lock une fois le Service Worker enregistr√© et la page charg√©e
                            requestWakeLock(); 
                        })
                        .catch(error => {
                            console.log('√âchec de l\'enregistrement du Service Worker:', error);
                        });
                });
            }
        });
    </script>
</body>
</html>
